<html>
  <head>
    <meta charset="utf-8"/>
    <title>Sugarizer Presence Simulator</title>
    <style>
	div {
		font-family: monospace;
	}
    </style>
  </head>
  <body>
  <h2 style="font-family: Arial">Sugarizer Presence Simulator</h2>
  <hr/>
  <div id="log"></div>

  <script src="../lib/require.js"></script>

  <script>
	// Init require library
	requirejs.config({ baseUrl: "../lib" });

	// Simulation settings
	var simulation = {
		action: { create: 5, sharing: "org.olpcfrance.PaintActivity" },
		during: 15000,
		count: 3
	};

	// Launch simulator
	var serverUrl = "http://localhost";
	var serverPort = 8039;
	runCommand(simulation);

	// Simulator
	function runCommand(command) {
		if (command.action && command.action.create) {
			// One step less
			if (command.count) {
				command.count--;
			}

			// Create users
			createUsers(command.action.create).then(function(users) {
				// Create share
				if (command.action.sharing) {
					users[0].createSharedActivity(command.action.sharing, function(sid) {
						messageLog("User "+colorId(users[0].getUserInfo().networkId)+" create activity '"+command.action.sharing+"' with "+colorId(sid));
						for (var i = 1 ; i < users.length ; i++) {
							var p = users[i];
							messageLog("User "+colorId(p.getUserInfo().networkId)+" join activity "+colorId(sid));
							p.joinSharedActivity(sid, function() {});
						}
					});
				}

				// Stop after a moment
				if (command.during) {
					setTimeout(function() {
						// Remove users
						for (var i = 0 ; i < users.length ; i++) {
							var p = users[i];
							messageLog("User "+colorId(p.getUserInfo().networkId)+" disconnected");
							p.leaveNetwork();
						}

						// Next step
						if (command.count) {
							runCommand(command);
						}
					}, command.during);
				}
			});
		}
};

	// Utility function
	function createUsers(count) {
		return new Promise(function(resolve, reject) {
			var users = [];
			createUsersInt(count, users, function() {
				resolve(users);
			});
		});
	}
	function createUsersInt(count, users, then) {
		if (users.length == count) {
			then(users);
			return;
		}
		createUser("Virtual User "+(users.length+1)).then(function(p) {
			messageLog("User "+colorId(p.getUserInfo().networkId)+" created");
			users.push(p);
			createUsersInt(count, users, then);
		});
	}
	function createUser(name) {
		return new Promise(function(resolve, reject) {
			requirejs(["sugar-web/presence", "sugar-web/graphics/xocolor"], function(presence, xocolor) {
				require.undef("sugar-web/presence"); // HACK: Force module unload to avoid reusing same socket
				var uid = createUUID();
				var colorindex = Math.floor(Math.random() * xocolor.colors.length);
				initSugarizer({name: name, server: {url: serverUrl, presence: serverPort}, networkId: uid,  color: colorindex, colorvalue: { stroke: xocolor.colors[colorindex].stroke, fill: xocolor.colors[colorindex].fill }});
				presence.joinNetwork(function(error, p) {
					resolve(p);
				});
			});
		});
	}
	function createUUID() {
		var s = [];
		var hexDigits = "0123456789abcdef";
		for (var i = 0; i < 36; i++) {
			s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
		}
		s[14] = "4";
		s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
		s[8] = s[13] = s[18] = s[23] = "-";

		var uuid = s.join("");
		return uuid;
	}
	function initSugarizer(updatedSettings) {
		window.localStorage.clear();
		var initSettings = { name: "Simulator", color: 163, colorvalue: { stroke: '#AC32FF', fill: '#FF8F00' } };
		if (updatedSettings) {
			for (var key in updatedSettings) {
				initSettings[key] = updatedSettings[key];
			}
		}
		window.localStorage.setItem("sugar_settings", JSON.stringify(initSettings));
	};
	var colors = [];
	function colorId(id) {
		var color;
		if (colors[id]) {
			color = colors[id];
		} else {
			color = "#"+((1<<24)*Math.random()|0).toString(16);
			colors[id] = color;
		}
		return "<font color='"+color+"'>"+id+"</font>"
	}
	var liIndex = 0;
	function messageLog(message) {
		var buf = "<font color='gray'>"+new Date().toISOString()+":</font> "+message;
		var log = document.getElementById("log");
		var li = document.createElement("div");
		li.id = "li"+(++liIndex);
		li.innerHTML = buf;
		log.appendChild(li);
		setTimeout(function() {
			document.getElementById("li"+liIndex).scrollIntoView();
		}, 50);
	}
  </script>
  </body>
</html>
